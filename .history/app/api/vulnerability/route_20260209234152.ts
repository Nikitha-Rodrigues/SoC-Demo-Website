import { NextResponse } from 'next/server'
import { getVulnerabilitiesCollection } from '../../../lib/mongo'
import pool from '../../../lib/mysql'
import mysql2 from 'mysql2'

function safeNumber(v: any) {
  if (v === '' || v === undefined || v === null) return null
  const n = Number(v)
  if (Number.isNaN(n)) throw new Error('Invalid number')
  return n
}

export async function POST(req: Request) {
  try {
    const body = await req.json()
    const action = body.action

    if (action === 'by_attack') {
      const attackId = safeNumber(body.attackId)
      if (!attackId) return NextResponse.json({ message: 'AttackID required' }, { status: 400 })
      
      // Get vulnerability IDs from MySQL
      const [vulnIds] = await pool.execute(
        `SELECT DISTINCT VulnerabilityID FROM attack_vulnerability
         WHERE AttackID = ?`,
        [attackId]
      )
      
      // Get vulnerabilities from MongoDB
      const col = await getVulnerabilitiesCollection()
      const ids = (vulnIds as any[]).map((row: any) => row.VulnerabilityID)
      const vulns = await col.find({ VulnerabilityID: { $in: ids } }).toArray()
      
      const query = `-- Vulnerabilities for AttackID ${attackId}
SELECT av.VulnerabilityID FROM attack_vulnerability av
WHERE av.AttackID = ${attackId}
-- Then lookup in MongoDB: db.vulnerabilities.find({ VulnerabilityID: { $in: [${ids.join(', ')}] } })`
      
      return NextResponse.json({ executed: query, rows: vulns })
    }

    if (action === 'by_severity') {
      const severity = (body.severity || 'High').toString()
      const col = await getVulnerabilitiesCollection()
      const docs = await col.find({ severity }).toArray()
      const query = `db.vulnerabilities.find({ severity: "${severity}" })`
      return NextResponse.json({ executed: query, rows: docs })
    }

    if (action === 'by_id') {
      const vulnId = (body.vulnId || '').toString()
      if (!vulnId) return NextResponse.json({ message: 'VulnerabilityID required' }, { status: 400 })
      const col = await getVulnerabilitiesCollection()
      const docs = await col.find({ $or: [{ VulnerabilityID: vulnId }, { _id: vulnId }] }).toArray()
      const query = `db.vulnerabilities.find({_id: ${vulnId}})`
      return NextResponse.json({ executed: query, rows: docs })
    }

    if (action === 'packets_by_vuln') {
      const vulnId = (body.vulnId || '').toString()
      if (!vulnId) return NextResponse.json({ message: 'VulnerabilityID required' }, { status: 400 })
      // Find packets related to attacks that reference this vulnerability
      const query = `
        SELECT p.* FROM packet p
        INNER JOIN attack_packet ap ON p.PacketID = ap.PacketID
        INNER JOIN attack_vulnerability av ON ap.AttackID = av.AttackID
        WHERE av.VulnerabilityID = ?
        ORDER BY p.Timestamp ASC
      `
      const executed = mysql2.format(query, [vulnId])
      const [rows] = await pool.execute(query, [vulnId])
      return NextResponse.json({ executed, rows })
    }

    if (action === 'flows_by_vuln') {
      const vulnId = (body.vulnId || '').toString()
      if (!vulnId) return NextResponse.json({ message: 'VulnerabilityID required' }, { status: 400 })
      const query = `
        SELECT DISTINCT f.* FROM flow f
        INNER JOIN packet p ON f.FlowID = p.FlowID
        INNER JOIN attack_packet ap ON p.PacketID = ap.PacketID
        INNER JOIN attack_vulnerability av ON ap.AttackID = av.AttackID
        WHERE av.VulnerabilityID = ?
        ORDER BY f.FlowStartTime ASC
      `
      const executed = mysql2.format(query, [vulnId])
      const [rows] = await pool.execute(query, [vulnId])
      return NextResponse.json({ executed, rows })
    }

    if (action === 'by_cwe') {
      const cwe = (body.cwe || '').toString()
      if (!cwe) return NextResponse.json({ message: 'CWE required' }, { status: 400 })
      const col = await getVulnerabilitiesCollection()
      const docs = await col.find({ CWECategory: { $regex: cwe, $options: 'i' } }).toArray()
      const query = `db.vulnerabilities.find({ CWECategory: { $regex: "${cwe}", $options: "i" } })`
      return NextResponse.json({ executed: query, rows: docs })
    }

    if (action === 'all') {
      const col = await getVulnerabilitiesCollection()
      const docs = await col.find({}).limit(100).toArray()
      const query = `db.vulnerabilities.find({}).limit(100)`
      return NextResponse.json({ executed: query, rows: docs })
    }

    return NextResponse.json({ message: 'Unknown action' }, { status: 400 })
  } catch (err: any) {
    console.error('Vulnerability API error:', err)
    return NextResponse.json({ message: err.message || 'Error' }, { status: 500 })
  }
}
